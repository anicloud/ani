# Anicel简介
anicel是Anicloud公司所开发的互联网智能硬件平台项目，旨在为互联网应用程序和智能硬件提供统一的集成平台，并提供面向最终用户的分发服务。

&copy;2014 Anicloud Limited

## 功能概述
Anicel是为设备提供安全的统一接入、认证、功能指令定义与数据流传输管道建立的互联网服务，将接入互联网的硬件设备与用户帐号关联，对上层互联网SaaS应用程序提供统一的、制造商无关的用户设备功能访问入口。
Anicel面向终端用户的client，为智能可穿戴设备（如：Android Wear设备，可能于2014年9月9日发布的iWatch）提供统一接入、互联网应用程序分发、面向所接入SaaS內容之聚合搜索以及快速控制服务。

## 工作机制
Anicel系统为**设备**提供**安全的统一接入、认证、功能指令定义与数据流直接传输通路建立**服务，将接入互联网的硬件设备与用户关联，为上层互联网应用程序提供统一的用户设备功能的访问入口。

Anicel的面向**终端用户**的客户端提供智能可穿戴设备（如：Android Wear设备，可能存在的iWatch）统一接入、互联网应用程序分发、应用内容聚合搜索以及快速控制服务。

## 设备功能定义
anicel将设备的控制指令以“**功能**”和“**功能组**”表示。对这部分的定义，请详见DeviceMeta概要设计文档。每个“功能”的构成为：

- 所有者
- 权限
- 属组
- 名称（组内唯一）
- 参数（带有类型约束）
- 返回值类型（带有类型约束）

## 应用程序定义
**应用程序**是anicel对设备功能调用者的描述，也是被实施调用权限控制的单位。一个应用程序，可以被授权控制某一用户的设备（组），从而实现对设备的简介控制。平台还负责完成建立应用程序和数据的交互连接，提供基于ICE的防火墙穿越机制。

## 设备接入流程
作为对下的设备接入层，设备的接入是anicel的核心功能之一。这部分的机制分为控制连接建立、直接数据连接建立两部分，由DeviceBus模块统一承担。

###控制连接的建立
控制链接，即发送/接收控制命令的可靠长物理连接，带有授信过程，采用TCP作为传输层协议。连接流程如下：

1. 由设备主动向anicel服务（实际是DeviceBus模块）请求，建立TCP长连接用于传输控制指令；
2. 设备发送控制认证消息至anicel，包含：
  * 消息时间戳（ms）
  * MAC地址（连接建立时直接自协议中获取）
  * 设备ID
  * HMAC验证码（根据设备密钥的MD5 Hash值创建），Hash明文顺序如下：设备ID、设备MAC、设备消息时间戳、设备密钥
3. 密钥推送（只在以下情况触发）：

  * 若设备没有注册过：anicel生成并写入与该设备与当前用户关联的密钥，Hash编码顺序如下：**设备ID**、**设备MAC**、**用户ID（系统随机生成的内部ID，亘古不变）**、**本次密钥生成的时间戳**；
  * 若设备虽然已经注册过，但因密钥泄露等原因导致在anicel上的密钥作废（时间戳被更新）：anicel重新写入该设备的密钥，但需要设备提供以下信息：该设备的已知密钥（生成规则同上）；之后系统将重复生成，并推送新密钥至设备；
4. 验证规则：

  * 时间戳是否过期：若超过合理的数据传输周期，则请求重发；若重试超过3次，则直接发送失败消息并断开TCP物理连接；
  * 设备是否已经注册：没有则进入3.1的流程；
  * 密钥是否正确：若不正确则尝试进入3.2的流程；若再不正确，则直接发送失败消息并断开TCP物理连接；
5. 若认证获得通过，连接建立；否则anicel发送连接建立失败的消息，断开TCP物理连接；

####直连数据连接的建立与防火墙穿越
数据连接由一个控制链接方法发起建立，与控制连接走不同的端口（类似FTP）。透过ICE、WebRTC等公有协议，实现对防火墙的穿越，建立基于传输层协议（UDP或TCP）之数据直连。

## 系统架构
![Architecture - anicel](https://github.com/anicloud/anicel/raw/master/system-design/Architecture-anicel.png)

###模块功能概述
anicel由4个服务器端功能模块和一个客户端模块构成，支持分布式部署与访问。

###DeviceBus
核心硬件接入管理模块，用于接受设备连接、维护硬件设备的状态信息；向设备发送控制指令并接收返回结果，负责建立设备与应用程序之间的点对点数据直连。

###RectManager
Rect是anicel系统所定义的设备应用程序，可以在用户允许的前提下通过anicel的DeviceBus直接向设备发送控制指令，并实时接收设备所返回的数据。RectManager是提供应用程序注册、编辑、与用户关联（安装）、查找、控制指令下达等功能的业务系统。

###DeviceManager
管理设备元信息、设备与用户关联关系的业务系统，定义设备方法并提供验证的后台逻辑，并且提供包含Rect（应用程序）的统一前端访问入口，使用系统的主web端口对外提供服务。

###Wilddragon
前端统一访问入口，是系统面向用户的统一平台界面。

###DeviceClient
为各个种类的设备（Android，Arduino等）提供的平台接入客户端，需要在每次连接时向平台汇报所属设备的类型、MAC地址、设备唯一识别码等信息，由平台判断用户的归属。呈现方式可以是apk，lib包或者功能控制芯片等。

###模块交互概述
为保证效率，内部系统间交互主要采用Apache Thrift、Java RMI等方式，不采用REST方式。